<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Calorie & Macro Tracker (Auto DB)</title>
  <style>
    /* (your existing CSS) */
    .hidden { display: none; }
  </style>
</head>
<body>
  <div id="authSection">
    <div id="userInfo" class="hidden">
      Logged in as: <span id="userEmail"></span>
      <button onclick="signOut()">Sign Out</button>
    </div>
    <div id="authForm">
      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="signIn()">Sign In</button>
      <button onclick="signUp()">Sign Up</button>
    </div>
  </div>

  <div class="main">
    <!-- your nutrition and log UI -->
    <!-- ... -->
  </div>
  <div class="sidebar">
    <table id="foodTable" class="hidden">
      <thead>
        <tr>
          <th>Time</th><th>Food</th><th>Weight (g)</th><th>Calories</th>
          <th>Protein</th><th>Carbs</th><th>Fat</th><th>Fiber</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="macroSummary" class="summary"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCDVZOggFk6Y4hCSU7prDjEnONqRLD2jcc",
      authDomain: "calorie-tracker-cf272.firebaseapp.com",
      projectId: "calorie-tracker-cf272",
      storageBucket: "calorie-tracker-cf272.appspot.com",
      messagingSenderId: "650970455289",
      appId: "1:650970455289:web:ed766275c675a0a1111628",
      measurementId: "G-5LHNSXQFDM"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const foodDB = {
      "brown rice cooked": { calories: 111, protein: 2.6, carbs: 23, fat: 0.9, fiber: 1.8 },
      // ... rest of your food items
    };

    let foods = [];
    let dailyNeeds = { calories:0, protein:0, carbs:0, fat:0, fiber:0 };

    // — Auth / Persistence / UI Handling —

    function signIn() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
        .then(() => {
          return firebase.auth().signInWithEmailAndPassword(email, password);
        })
        .then((userCredential) => {
          console.log("✅ Signed in:", userCredential.user.email);
        })
        .catch(error => {
          alert("Sign-in failed: " + error.message);
        });
    }

    function signUp() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
        .then(() => {
          return firebase.auth().createUserWithEmailAndPassword(email, password);
        })
        .then((userCredential) => {
          const user = userCredential.user;
          // Optionally send verification
          user.sendEmailVerification()
            .then(() => {
              alert("Verification email sent. Please check your inbox.");
            });
        })
        .catch(error => {
          alert("Sign-up failed: " + error.message);
        });
    }

    function signOut() {
      firebase.auth().signOut()
        .then(() => {
          console.log("✅ Signed out");
        })
        .catch(error => {
          alert("Sign-out error: " + error.message);
        });
    }

    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        console.log("✅ User is signed in:", user.uid);
        document.querySelector(".main").style.display = "block";
        document.querySelector(".sidebar").style.display = "block";
        document.getElementById("userInfo").classList.remove("hidden");
        document.getElementById("authForm").classList.add("hidden");
        document.getElementById("userEmail").textContent = user.email || "Anonymous";
        loadFoodFromFirestore();
      } else {
        console.log("⚠️ No user signed in.");
        document.getElementById("userInfo").classList.add("hidden");
        document.getElementById("authForm").classList.remove("hidden");
        // ❌ REMOVE signInAnonymously unless you want guests
      }
    });

    // — Food Log Functions —

    function loadFoodFromFirestore() {
      const user = firebase.auth().currentUser;

      if (!user) {
        console.error("❌ No user signed in.");
        return;
      }

      db.collection("foodLogs")
        .where("userId", "==", user.uid)
        .orderBy("time", "desc")
        .get()
        .then((snapshot) => {
          foods = [];
          if (snapshot.empty) {
            console.warn("⚠️ No food logs found for user:", user.uid);
          }
          snapshot.forEach((doc) => {
            const data = doc.data();
            data.id = doc.id; // ← add this if you want to delete/edit later
            foods.push(data);
          });
          console.log("✅ Loaded foods:", foods);
          renderFoodTable();
          updateMacroSummary();
        })
        .catch((error) => {
          console.error("Error loading food logs:", error);
        });
    }

    function addFood() {
      const user = firebase.auth().currentUser;
      if (!user) {
        alert("You must be signed in.");
        return;
      }
      const name = document.getElementById("foodName").value.trim().toLowerCase();
      const weight = parseFloat(document.getElementById("foodWeight").value);
      if (!name || isNaN(weight) || weight <= 0) {
        alert("Please enter valid food & weight.");
        return;
      }
      const foodInfo = foodDB[name];
      if (!foodInfo) {
        alert("Food not found.");
        return;
      }
      const factor = weight / 100;
      const foodEntry = {
        userId: user.uid,
        name: name,
        weight: weight,
        calories: +(foodInfo.calories * factor).toFixed(1),
        protein: +(foodInfo.protein * factor).toFixed(1),
        carbs: +(foodInfo.carbs * factor).toFixed(1),
        fat: +(foodInfo.fat * factor).toFixed(1),
        fiber: +(foodInfo.fiber * factor).toFixed(1),
        time: new Date().toISOString()
      };

      db.collection("foodLogs").add(foodEntry)
        .then(() => {
          document.getElementById("status").textContent = `✅ Added: ${name} (${weight}g)`;
          // Prepend or push
          foods.unshift(foodEntry);
          renderFoodTable();
          updateMacroSummary();
          document.getElementById("foodName").value = "";
          document.getElementById("foodWeight").value = "";
        })
        .catch(error => {
          alert("Error saving: " + error.message);
        });
    }

    function renderFoodTable() {
      const tbody = document.querySelector("#foodTable tbody");
      tbody.innerHTML = "";
      foods.forEach((food, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${new Date(food.time).toLocaleTimeString()}</td>
          <td>${food.name}</td>
          <td><input type="number" value="${food.weight}" onchange="editFood(${index}, this.value)" /></td>
          <td>${food.calories}</td>
          <td>${food.protein}</td>
          <td>${food.carbs}</td>
          <td>${food.fat}</td>
          <td>${food.fiber}</td>
          <td><button onclick="deleteFood(${index})">❌</button></td>
        `;
        tbody.appendChild(row);
      });
      document.getElementById("foodTable").classList.remove("hidden");
    }

    function editFood(index, newWeight) {
      newWeight = parseFloat(newWeight);
      if (isNaN(newWeight) || newWeight <= 0) {
        alert("Weight must be positive.");
        renderFoodTable();
        return;
      }
      const food = foods[index];
      const base = foodDB[food.name];
      const factor = newWeight / 100;
      const newObj = {
        ...food,
        weight: newWeight,
        calories: +(base.calories * factor).toFixed(1),
        protein: +(base.protein * factor).toFixed(1),
        carbs: +(base.carbs * factor).toFixed(1),
        fat: +(base.fat * factor).toFixed(1),
        fiber: +(base.fiber * factor).toFixed(1)
      };
      // Update both locally and in Firestore
      if (food.id) {
        db.collection("foodLogs").doc(food.id).update(newObj)
          .then(() => {
            foods[index] = newObj;
            renderFoodTable();
            updateMacroSummary();
          })
          .catch(error => {
            alert("Error updating: " + error.message);
          });
      } else {
        foods[index] = newObj;
        renderFoodTable();
        updateMacroSummary();
      }
    }

    function deleteFood(index) {
      const food = foods[index];
      if (!food.id) {
        alert("Cannot delete: no id.");
        return;
      }
      db.collection("foodLogs").doc(food.id).delete()
        .then(() => {
          foods.splice(index, 1);
          renderFoodTable();
          updateMacroSummary();
        })
        .catch(error => {
          alert("Delete error: " + error.message);
        });
    }

    function updateMacroSummary() {
      const totals = { calories:0, protein:0, carbs:0, fat:0, fiber:0 };
      for (const food of foods) {
        totals.calories += food.calories;
        totals.protein += food.protein;
        totals.carbs += food.carbs;
        totals.fat += food.fat;
        totals.fiber += food.fiber;
      }
      const remaining = {
        calories: Math.max(0, dailyNeeds.calories - totals.calories).toFixed(1),
        protein: Math.max(0, dailyNeeds.protein - totals.protein).toFixed(1),
        carbs: Math.max(0, dailyNeeds.carbs - totals.carbs).toFixed(1),
        fat: Math.max(0, dailyNeeds.fat - totals.fat).toFixed(1),
        fiber: Math.max(0, dailyNeeds.fiber - totals.fiber).toFixed(1)
      };
      document.getElementById("macroSummary").innerHTML = `
        <strong>Today So Far:</strong><br/>
        Calories: ${totals.calories.toFixed(1)} / ${dailyNeeds.calories} kcal<br/>
        Protein: ${totals.protein.toFixed(1)}g / ${dailyNeeds.protein}g<br/>
        Carbs: ${totals.carbs.toFixed(1)}g / ${dailyNeeds.carbs}g<br/>
        Fat: ${totals.fat.toFixed(1)}g / ${dailyNeeds.fat}g<br/>
        Fiber: ${totals.fiber.toFixed(1)}g / ${dailyNeeds.fiber}g<br/>
        <br/>
        <strong>Remaining:</strong><br/>
        Calories: ${remaining.calories} kcal<br/>
        Protein: ${remaining.protein}g<br/>
        Carbs: ${remaining.carbs}g<br/>
        Fat: ${remaining.fat}g<br/>
        Fiber: ${remaining.fiber}g
      `;
    }

    function toggleFoodList() {
      document.getElementById("foodTable").classList.toggle("hidden");
    }

    function populateFoodOptions() {
      const datalist = document.getElementById("foodOptions");
      datalist.innerHTML = "";
      for (const food in foodDB) {
        const option = document.createElement("option");
        option.value = food;
        datalist.appendChild(option);
      }
    }

    populateFoodOptions();
  </script>
</body>
</html>
