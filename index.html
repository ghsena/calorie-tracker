<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Calorie & Macro Tracker (Auto DB)</title>
  <style>
    .hidden {
      display: none;
    }

    .main input,
    .main button {
      margin: 5px;
    }

    .daily-needs {
      margin: 20px 0;
      padding: 10px;
      border: 1px solid #ccc;
      background: #f9f9f9;
    }

    .daily-needs label {
      display: block;
      margin-bottom: 6px;
    }
  </style>

</head>
<body>
  <div id="authSection">
    <div id="userInfo" class="hidden">
      Logged in as: <span id="userEmail"></span>
      <button onclick="signOut()">Sign Out</button>
    </div>
    <div id="authForm">
      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="signIn()">Sign In</button>
      <button onclick="signUp()">Sign Up</button>
    </div>
  </div>

  <div class="main">
  <h3>Add Food</h3>
  <input list="foodOptions" id="foodName" placeholder="Enter food name" />
  <datalist id="foodOptions"></datalist>
  <input type="number" id="foodWeight" placeholder="Weight (g)" />
  <button onclick="addFood()">Add Food</button>
  <p id="status"></p>
</div>

  <!-- ✅ STEP 1: Daily Needs Input UI -->
  <div class="daily-needs">
    <h3>Set Daily Nutritional Goals</h3>
    <label>Calories: <input type="number" id="dailyCalories" /></label>
    <label>Protein (g): <input type="number" id="dailyProtein" /></label>
    <label>Carbs (g): <input type="number" id="dailyCarbs" /></label>
    <label>Fat (g): <input type="number" id="dailyFat" /></label>
    <label>Fiber (g): <input type="number" id="dailyFiber" /></label>
    <button onclick="calculateNeeds()">Set Goals</button>
  </div>

  <div class="sidebar">
    <table id="foodTable" class="hidden">
      <thead>
        <tr>
          <th>Time</th><th>Food</th><th>Weight (g)</th><th>Calories</th>
          <th>Protein</th><th>Carbs</th><th>Fat</th><th>Fiber</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="macroSummary" class="summary"></div>
  </div>

  <!-- Firebase + Your App Scripts -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCDVZOggFk6Y4hCSU7prDjEnONqRLD2jcc",
      authDomain: "calorie-tracker-cf272.firebaseapp.com",
      projectId: "calorie-tracker-cf272",
      storageBucket: "calorie-tracker-cf272.appspot.com",
      messagingSenderId: "650970455289",
      appId: "1:650970455289:web:ed766275c675a0a1111628",
      measurementId: "G-5LHNSXQFDM"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const foodDB = {
      "brown rice cooked": { calories: 111, protein: 2.6, carbs: 23, fat: 0.9, fiber: 1.8 },
      // Add more foods here
    };

    let foods = [];
    let dailyNeeds = { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0 };

    function signIn() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
        .then(() => firebase.auth().signInWithEmailAndPassword(email, password))
        .catch(error => alert("Sign-in failed: " + error.message));
    }

    function signUp() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
        .then(() => firebase.auth().createUserWithEmailAndPassword(email, password))
        .then((userCredential) => {
          const user = userCredential.user;
          user.sendEmailVerification()
            .then(() => alert("Verification email sent. Please check your inbox."));
        })
        .catch(error => alert("Sign-up failed: " + error.message));
    }

    function signOut() {
      firebase.auth().signOut()
        .then(() => console.log("✅ Signed out"))
        .catch(error => alert("Sign-out error: " + error.message));
    }

    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        console.log("✅ User is signed in:", user.uid);
        document.querySelector(".main").style.display = "block";
        document.querySelector(".sidebar").style.display = "block";
        document.getElementById("userInfo").classList.remove("hidden");
        document.getElementById("authForm").classList.add("hidden");
        document.getElementById("userEmail").textContent = user.email || "Anonymous";
        loadFoodFromFirestore();

        // ✅ Auto-set some default values on login (optional)
        dailyNeeds = { calories: 2000, protein: 150, carbs: 250, fat: 70, fiber: 30 };
        updateMacroSummary();
      } else {
        console.log("⚠️ No user signed in.");
        document.getElementById("userInfo").classList.add("hidden");
        document.getElementById("authForm").classList.remove("hidden");
      }
    });

    function calculateNeeds() {
      const c = parseFloat(document.getElementById("dailyCalories").value);
      const p = parseFloat(document.getElementById("dailyProtein").value);
      const carbs = parseFloat(document.getElementById("dailyCarbs").value);
      const f = parseFloat(document.getElementById("dailyFat").value);
      const fiber = parseFloat(document.getElementById("dailyFiber").value);

      if ([c, p, carbs, f, fiber].some(v => isNaN(v) || v < 0)) {
        alert("Please enter valid numbers for all fields.");
        return;
      }

      dailyNeeds = {
        calories: c,
        protein: p,
        carbs: carbs,
        fat: f,
        fiber: fiber
      };

      updateMacroSummary();
    }

    function loadFoodFromFirestore() {
      const user = firebase.auth().currentUser;
      if (!user) return;
      db.collection("foodLogs")
        .where("userId", "==", user.uid)
        .orderBy("time", "desc")
        .get()
        .then(snapshot => {
          foods = [];
          snapshot.forEach(doc => {
            const obj = doc.data();
            obj.id = doc.id;
            foods.push(obj);
          });
          renderFoodTable();
          updateMacroSummary();
        })
        .catch(error => console.error("Error loading food logs:", error));
    }

    function addFood() {
      const user = firebase.auth().currentUser;
      if (!user) return alert("You must be signed in.");
      const name = document.getElementById("foodName").value.trim().toLowerCase();
      const weight = parseFloat(document.getElementById("foodWeight").value);
      if (!name || isNaN(weight) || weight <= 0) return alert("Please enter valid food & weight.");
      const foodInfo = foodDB[name];
      if (!foodInfo) return alert("Food not found.");
      const factor = weight / 100;
      const foodEntry = {
        userId: user.uid,
        name,
        weight,
        calories: +(foodInfo.calories * factor).toFixed(1),
        protein: +(foodInfo.protein * factor).toFixed(1),
        carbs: +(foodInfo.carbs * factor).toFixed(1),
        fat: +(foodInfo.fat * factor).toFixed(1),
        fiber: +(foodInfo.fiber * factor).toFixed(1),
        time: new Date().toISOString()
      };
      db.collection("foodLogs").add(foodEntry)
        .then(() => {
          foods.unshift(foodEntry);
          renderFoodTable();
          updateMacroSummary();
        })
        .catch(error => alert("Error saving: " + error.message));
    }

    function renderFoodTable() {
      const tbody = document.querySelector("#foodTable tbody");
      tbody.innerHTML = "";
      foods.forEach((food, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${new Date(food.time).toLocaleTimeString()}</td>
          <td>${food.name}</td>
          <td><input type="number" value="${food.weight}" onchange="editFood(${index}, this.value)" /></td>
          <td>${food.calories}</td>
          <td>${food.protein}</td>
          <td>${food.carbs}</td>
          <td>${food.fat}</td>
          <td>${food.fiber}</td>
          <td><button onclick="deleteFood(${index})">❌</button></td>
        `;
        tbody.appendChild(row);
      });
      document.getElementById("foodTable").classList.remove("hidden");
    }

    function editFood(index, newWeight) {
      newWeight = parseFloat(newWeight);
      if (isNaN(newWeight) || newWeight <= 0) {
        alert("Weight must be positive.");
        renderFoodTable();
        return;
      }
      const food = foods[index];
      const base = foodDB[food.name];
      const factor = newWeight / 100;
      const newObj = {
        ...food,
        weight: newWeight,
        calories: +(base.calories * factor).toFixed(1),
        protein: +(base.protein * factor).toFixed(1),
        carbs: +(base.carbs * factor).toFixed(1),
        fat: +(base.fat * factor).toFixed(1),
        fiber: +(base.fiber * factor).toFixed(1)
      };
      if (food.id) {
        db.collection("foodLogs").doc(food.id).update(newObj)
          .then(() => {
            foods[index] = newObj;
            renderFoodTable();
            updateMacroSummary();
          })
          .catch(error => alert("Error updating: " + error.message));
      }
    }

    function deleteFood(index) {
      const food = foods[index];
      if (!food.id) return alert("Cannot delete: no id.");
      db.collection("foodLogs").doc(food.id).delete()
        .then(() => {
          foods.splice(index, 1);
          renderFoodTable();
          updateMacroSummary();
        })
        .catch(error => alert("Delete error: " + error.message));
    }

    function updateMacroSummary() {
      const totals = { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0 };
      for (const food of foods) {
        totals.calories += food.calories;
        totals.protein += food.protein;
        totals.carbs += food.carbs;
        totals.fat += food.fat;
        totals.fiber += food.fiber;
      }
      const remaining = {
        calories: Math.max(0, dailyNeeds.calories - totals.calories).toFixed(1),
        protein: Math.max(0, dailyNeeds.protein - totals.protein).toFixed(1),
        carbs: Math.max(0, dailyNeeds.carbs - totals.carbs).toFixed(1),
        fat: Math.max(0, dailyNeeds.fat - totals.fat).toFixed(1),
        fiber: Math.max(0, dailyNeeds.fiber - totals.fiber).toFixed(1)
      };
      document.getElementById("macroSummary").innerHTML = `
        <strong>Today So Far:</strong><br/>
        Calories: ${totals.calories.toFixed(1)} / ${dailyNeeds.calories} kcal<br/>
        Protein: ${totals.protein.toFixed(1)}g / ${dailyNeeds.protein}g<br/>
        Carbs: ${totals.carbs.toFixed(1)}g / ${dailyNeeds.carbs}g<br/>
        Fat: ${totals.fat.toFixed(1)}g / ${dailyNeeds.fat}g<br/>
        Fiber: ${totals.fiber.toFixed(1)}g / ${dailyNeeds.fiber}g<br/><br/>
        <strong>Remaining:</strong><br/>
        Calories: ${remaining.calories} kcal<br/>
        Protein: ${remaining.protein}g<br/>
        Carbs: ${remaining.carbs}g<br/>
        Fat: ${remaining.fat}g<br/>
        Fiber: ${remaining.fiber}g
      `;
    }

    function toggleFoodList() {
      document.getElementById("foodTable").classList.toggle("hidden");
    }

    function populateFoodOptions() {
      const datalist = document.getElementById("foodOptions");
      datalist.innerHTML = "";
      for (const food in foodDB) {
        const option = document.createElement("option");
        option.value = food;
        datalist.appendChild(option);
      }
    }

    populateFoodOptions();
  </script>
</body>
</html>
